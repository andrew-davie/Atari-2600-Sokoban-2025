#include "rooms.h"
#include "attribute.h"
#include "defines_cdfj.h"
#include "drawplayer.h"
#include "main.h"
#include "man.h"
#include "random.h"
#include "score.h"
#include "scroll.h"

int pillCount;

// Sokoban level data

// clang-format off

const char *room[] = {

#define NEXTLINE '|'
#define WALL '#'
#define PLAYERONGOAL '+'
#define PLAYERONNORMAL '@'
#define BOXONTARGET '*'
#define TARGET '.'
#define GAP ' '
#define GAP2 '-'
#define GAP3 '_'
#define BOX '$'

// To add new rooms just place either compressed or uncompressed room here.
// Rooms are standard-format, represented as a single 0-terminated string
// tools/compressroom.py will compress a room for you


// Collection/Set: DD-1
// Serial Number: 19
// Name: DD-1 19
// Author: David Dahlem
// Width: 8
// Height: 15
// Nb Boxes: 13
// Pushes: 1090
// Moves: 4680



// "4#|# .#|#2 3#|#*@2 #|#2 $ #|#2 3#|`4#", // what the `  ??
// "6#|#4 #|# #@ #|# $* #|# .* #|#4 #|6#",
// "6 6#|6 #4 #|6 # @2 3#|4#2 #6 #|#2 4#2.#.#$5#|# $ $ 2#3.6 #|#5 5.#2$3 #|6# 2#$2# 5#|5 #2 $4 #|5 4# 4#|7 #2 #|7 #2 5#|5 3# $4 #|5 #2 $ $3 #|5 # #$# 4#|5 #5 #|5 7#",

    #if 1

    "############################|"\
"###########  #######   #   #|"\
"## $                 #   $ #|"\
"## ##### ## ############# ##|"\
"## #     ## #..#  #  # .   #|"\
"## #  ## #   $ #*.$  # #   #|"\
"## ## #  #  #  #..#  # #####|"\
"#     # ### #* #*.#  # ## ##|"\
"#  ##$#     #  #..#  # # # #|"\
"## #  #######* #*.#  # ## ##|"\
"## #     #  #   ..#  # #####|"\
"## # #   $  #  #..#  #     #|"\
"## #$## ##  ####### ###### #|"\
"#  # $ @# $$ #  #          #|"\
"# $$ $###  $    # #  # # # #|"\
"#  #       ##   #          #|"\
"############################|",

// "####|"\
// "# .#|"\
// "#  ###|"\
// "#*@  #|"\
// "#  $ #|"\
// "#  ###|"\
// "####|"\
//

"4#|# .#|#2 3#|#*@2 #|#2 $ #|#2 3#|`4#",

// "######|"\
// "#    #|"\
// "# #@ #|"\
// "# $* #|"\
// "# .* #|"\
// "#    #|"\
// "######|"\

"6#|#4 #|# #@ #|# $* #|# .* #|#4 #|6#",

"  ####|"\
"###  ####|"\
"#     $ #|"\
"# #  #$ #|"\
"# . .#@ #|"\
"#########|"\

,

"########|"\
"#      #|"\
"# .**$@#|"\
"#      #|"\
"#####  #|"\
"    ####|"\
,
" #######|"\
" #     #|"\
" # .$. #|"\
"## $@$ #|"\
"#  .$. #|"\
"#      #|"\
"########"\
,

"###### #####|"\
"#    ###   #|"\
"# $$     #@#|"\
"# $ #...   #|"\
"#   ########|"\
"#####"\
,

"#######|"\
"#     #|"\
"# .$. #|"\
"# $.$ #|"\
"# .$. #|"\
"# $.$ #|"\
"#  @  #|"\
"#######|"\
,
"  ######|"\
"  # ..@#|"\
"  # $$ #|"\
"  ## ###|"\
"   # #|"\
"   # #|"\
"#### #|"\
"#    ##|"\
"# #   #|"\
"#   # #|"\
"###   #|"\
"  #####|"\
,
"#####|"\
"#.  ##|"\
"#@$$ #|"\
"##   #|"\
" ##  #|"\
"  ##.#|"\
"   ###|"\
,
"      #####|"\
"      #.  #|"\
"      #.# #|"\
"#######.# #|"\
"# @ $ $ $ #|"\
"# # # # ###|"\
"#       #|"\
"#########|"\
,

"  ######|"\
"  #    #|"\
"  # ##@##|"\
"### # $ #|"\
"# ..# $ #|"\
"#       #|"\
"#  ######|"\
"####|"\
,
"#####|"\
"#   ##|"\
"# $  #|"\
"## $ ####|"\
" ###@.  #|"\
"  #  .# #|"\
"  #     #|"\
"  #######|"\
,
"####|"\
"#. ##|"\
"#.@ #|"\
"#. $#|"\
"##$ ###|"\
" # $  #|"\
" #    #|"\
" #  ###|"\
" ####|"\
,
"#######|"\
"#     #|"\
"# # # #|"\
"#. $*@#|"\
"#   ###|"\
"#####|"\
,
"     ###|"\
"######@##|"\
"#    .* #|"\
"#   #   #|"\
"#####$# #|"\
"    #   #|"\
"    #####|",

"      ######|"
"      #    #|"
"      # @  ###|"
"####  #      #|"
"#  ####..#.#$#####|"
"# $ $ ##...      #|"
"#     .....#$$   #|"
"###### ##$## #####|"
"     #  $    #|"
"     #### ####|"
"       #  #|"
"       #  #####|"
"     ### $    #|"
"     #  $ $   #|"
"     # #$# ####|"
"     #     #|"
"     #######",

//"6 6#|6 #4 #|6 # @2 3#|4#2 #6 #|#2 4#2.#.#$5#|# $ $ 2#3.6 #|#5 5.#2$3 #|6# 2#$2# 5#|5 #2 $4 #|5 4# 4#|7 #2 #|7 #2 5#|5 3# $4 #|5 #2 $ $3 #|5 # #$# 4#|5 #5 #|5 7#",

" ####|"\
"##  ###########|"\
"#@$ .$  $  $  #|"\
"# $* .$.*.*.*.#|"\
"## *$  $      #|"\
" # . ##########|"\
" # . #|"\
" #####",


" ####   |"\
" #@ ####|"\
" #  #  #|"\
"## .#$ #|"\
"# $ $  #|"\
"#  * #.#|"\
"#  #  .#|"\
"########",




// "############################|"\
// "###########  #######   #   #|"\
// "## $                 #   $ #|"\
// "## ##### ## ############# ##|"\
// "## #     ## #..#  #  # .   #|"\
// "## #  ## #   $ #*.$  # #   #|"\
// "## ## #  #  #  #..#  # #####|"\
// "#     # ### #* #*.#  # ## ##|"\
// "#  ##$#     #  #..#  # # # #|"\
// "## #  #######* #*.#  # ## ##|"\
// "## #     #  #   ..#  # #####|"\
// "## # #   $  #  #..#  #     #|"\
// "## #$## ##  ####### ###### #|"\
// "#  # $ @# $$ #  #          #|"\
// "# $$ $###  $    # #  # # # #|"\
// "#  #       ##   #          #|"\
// "############################",

#endif

#if 0

"      ######|"
"      #    #|"
"      # @  ###|"
"####  #      #|"
"#  ####..#.#$#####|"
"# $ $ ##...      #|"
"#     .....#$$   #|"
"###### ##$## #####|"
"     #  $    #|"
"     #### ####|"
"       #  #|"
"       #  #####|"
"     ### $    #|"
"     #  $ $   #|"
"     # #$# ####|"
"     #     #|"
"     #######",



"  ####|\
  #  #|\
  #$ #|\
  #  # ####|\
### ####  #|\
#  .. ..  ###|\
# $*. *.$@  #|\
## #$ $#$ # #|\
 # #   #  # #|\
 #  ######  #|\
 ##        ##|\
  ##########",

// "     #######|\
//      #  @  #|\
//      # ### ##|\
// #### # # #  #####|\
// #  ### # # .    #|\
// # .    # # * $$ #|\
// # * $$ # # *## ##|\
// # *## ## # *   #|\
// # .   #  # *## #|\
// #  ####  # .   #|\
// ####     #  ####|\
//          ####",

// " ########|\
// ##      ##|\
// # .####  #|\
// # .    # #|\
// # * $$ # #|\
// # *## #  #|\
// # +   # ##|\
// # $###  #|\
// ##     ##|\
//  #######|",




"3 3#|  ## # 4#| ##  3#  #|## $6 #|#3 @$ #  #|3# $3#  #|  #  #2.2 #| ## ##.# ##| #6 ##| #5 ##| 7#",


// " ## #####|"
// "## ## . #|"
// "# ## $. #|"
// " ## $   #|"
// "## $@ ###|"
// "# $  ##|"
// "#.. ## ##|"
// "#   # ##|"
// "##### #",

// "           #####|"
// "          ##   #|"
// "          #    #|"
// "    ####  # $ ##|"
// "    #  ####$ $#|"
// "    #     $ $ #|"
// "   ## ## $ $ $#|"
// "   #  .#  $ $ #|"
// "   #  .#      #|"
// "##### #########|"
// "#.... @  #|"
// "#....    #|"
// "##  ######|"
// " ####",

// "  ###########|"
// " ##     #  @#|"
// "### $ $$#   #|"
// "# ##$    $$ #|"
// "#  #  $ #   #|"
// "###### ######|"
// "#.. ..$ #*##|"
// "# ..    ###|"
// "#  ..#####|"
// "#########",


// "           ######|"
// "    ####  ##    #|"
// "  ###  #  #  ## ###|"
// "###    #### #   $ #|"
// "#  $ @ ...*..  $  #|"
// "# $ $  ## ###   ###|"
// "### ###   # #####|"
// " #      ###|"
// " #   ####|"
// " #####",

// "    #######|"
// "    #     ##|"
// "##### ###  ##|"
// "#       #  ##|"
// "#@$***. ##$ #|"
// "#  #    ## .#|"
// "##  ##  # $ #|"
// " ##  ####.$.#|"
// "  ##        #|"
// "   ######  ##|"
// "        ####",

"#########|"
"#. .    #|"
"#.$. .  #|"
"## ###@ #|"
" #  $  ##|"
" # $$ ##|"
" #  $ #|"
" #  ###|"
" ####",

// "      ######|"
// "      #    #|"
// "      # @  ###|"
// "####  #      #|"
// "#  ####..#.#$#####|"
// "# $ $ ##...      #|"
// "#     .....#$$   #|"
// "###### ##$## #####|"
// "     #  $    #|"
// "     #### ####|"
// "       #  #|"
// "       #  #####|"
// "     ### $    #|"
// "     #  $ $   #|"
// "     # #$# ####|"
// "     #     #|"
// "     #######",


"####|"\
"# .#|"\
"#  ###|"\
"#*@  #|"\
"#  $ #|"\
"#  ###|"\
"####|"\
//
,
"######|"\
"#    #|"\
"# #@ #|"\
"# $* #|"\
"# .* #|"\
"#    #|"\
"######|"\

,
// "  ####|"\
// "###  ####|"\
// "#     $ #|"\
// "# #  #$ #|"\
// "# . .#@ #|"\
// "#########|"\

// ,

// "########|"\
// "#      #|"\
// "# .**$@#|"\
// "#      #|"\
// "#####  #|"\
// "    ####|"\
// ,
// " #######|"\
// " #     #|"\
// " # .$. #|"\
// "## $@$ #|"\
// "#  .$. #|"\
// "#      #|"\
// "########|"\
// ,

// "###### #####|"\
// "#    ###   #|"\
// "# $$     #@#|"\
// "# $ #...   #|"\
// "#   ########|"\
// "#####|"\
// ,

// "#######|"\
// "#     #|"\
// "# .$. #|"\
// "# $.$ #|"\
// "# .$. #|"\
// "# $.$ #|"\
// "#  @  #|"\
// "#######|"\
// ,
// "  ######|"\
// "  # ..@#|"\
// "  # $$ #|"\
// "  ## ###|"\
// "   # #|"\
// "   # #|"\
// "#### #|"\
// "#    ##|"\
// "# #   #|"\
// "#   # #|"\
// "###   #|"\
// "  #####|"\
,
"#####|"\
"#.  ##|"\
"#@$$ #|"\
"##   #|"\
" ##  #|"\
"  ##.#|"\
"   ###|"\
,
"      #####|"\
"      #.  #|"\
"      #.# #|"\
"#######.# #|"\
"# @ $ $ $ #|"\
"# # # # ###|"\
"#       #|"\
"#########|"\
,

"  ######|"\
"  #    #|"\
"  # ##@##|"\
"### # $ #|"\
"# ..# $ #|"\
"#       #|"\
"#  ######|"\
"####|"\
,
"#####|"\
"#   ##|"\
"# $  #|"\
"## $ ####|"\
" ###@.  #|"\
"  #  .# #|"\
"  #     #|"\
"  #######|"\
,
"####|"\
"#. ##|"\
"#.@ #|"\
"#. $#|"\
"##$ ###|"\
" # $  #|"\
" #    #|"\
" #  ###|"\
" ####|"\
,
"#######|"\
"#     #|"\
"# # # #|"\
"#. $*@#|"\
"#   ###|"\
"#####|"\
,
"     ###|"\
"######@##|"\
"#    .* #|"\
"#   #   #|"\
"#####$# #|"\
"    #   #|"\
"    #####|",


"  ########|\
 ##  . . #|\
 # *$# # #|\
 #.  #$# ##|\
##* #  #  #|\
#   # *   #|\
# $#@ .#  #|\
#     $ ###|\
##  #   #|\
 ########",
 
 "   ####|\
   #  #|\
   #$ #|\
   #  # ####|\
#### ####  #|\
#   .. ..  #|\
#  $*. *.$@##|\
#   #$ $#$  #|\
#####   #   #|\
    #########",

"  ####|\
  #  #|\
  #$ #|\
  #  # ####|\
### ####  #|\
#  .. ..  ###|\
# $*. *.$@  #|\
## #$ $#$ # #|\
 # #   #  # #|\
 #  ######  #|\
 ##        ##|\
  ##########",

// "     #######|\
//      #  @  #|\
//      # ### ##|\
// #### # # #  #####|\
// #  ### # # .    #|\
// # .    # # * $$ #|\
// # * $$ # # *## ##|\
// # *## ## # *   #|\
// # .   #  # *## #|\
// #  ####  # .   #|\
// ####     #  ####|\
//          ####",

" ########|\
##      ##|\
# .####  #|\
# .    # #|\
# * $$ # #|\
# *## #  #|\
# +   # ##|\
# $###  #|\
##     ##|\
 #######|",

 #endif
"6 5#|6 #3 #|6 #-$-#|6 #3 #|6 2#-2#|7 #.#|5#-2#-2#-5#|#3 3#-.-3#3 #|#-$5 @5 $-#|#3 3#-.-3#3 #|5#-2#-2#-5#|7 #.#|8#-8#|#-*-*-*3 *-*-*-#|#7 $7 #|2#2 *-*3 *-*2 2#|17#",
"5#-5#|#3.3#3 #|#3.4 @-#|#.-.3#3 #|3#-#-#-3#|2 #$#-#$#|3#-#-#-3#|#3 #-#3 #|#-$-#-#-$-#|#-$-#-#-$-#|#-$-#-#-$-#|#3 #-#3 #|5#-5#",
"-4#|-#2 6#|-#-$3 $-#|-#3 #-#-#|2#3*.2*@#|#2 .2 .-2#|#-#-2#$2#|#6 #|8#",
"3 3#|2 #-@-#|-#-$#$-#|-#-.*.-#|#2 *.*2 #|#2 $-$2 #|4#.-3#|3 #2 #|3 4#",
"7#|#4.-#|#-3$-#|#-$@$-#|#-3$-#|#-4.#|7#",
"7#|#-2.2 #|#.3$-#|#.$@$.#|#-3$.#|#2 2.-#|7#",
"3 #|2 #.#|-#.$.#|#.3$.#|-#-$-#|-#-@-#|-5#",
"-5#|2#3 2#|#2 #2 #|#.$@$.#|#-3$-#|#.-.-.#|7#",
"7#|#5 #|#-*-*-#|#*-$-*#|#-*.*-#|#2 @2 #|7#",
"4 4#5 #|3 #3 #4 #|2 2#-#-5#|-3#2 4.-#-#|6#.3$-2#|5 #.$@$-#|5 #.3$-#-#|5 #4 .2#|5 7#|9 #|7 3#",
#if 0
"15#|#6 @6 #|#-3*5 3*-#|#-*-7$-*-#|#-*-7.-*-#|#-11*-#|#13 #|15#",
"2 5#|2 #3 #|3#$.$3#|#-$3 $-#|#3.@3.#|#-$3 $-#|3#$.$3#|2 #3 #|2 5#",
"2 5#|2 #-.-#|3#$.$3#|#-$3 $-#|#2.-@-2.#|#-$3 $-#|3#$.$3#|2 #-.-#|2 5#",
"2 5#|2 #3 #|3#$.$3#|#-$-.-$-#|#-2.@2.-#|#-$-.-$-#|3#$.$3#|2 #3 #|2 5#",
"2 2#3 2#|-#2 #-#2 #|#-$2 #2 $-#|#2 $-.-$2 #|-#2 *.*2 #|2 #2.@2.#|-#2 *.*2 #|#2 $-.-$2 #|#-$2 #2 $-#|-#2 #-#2 #|2 2#3 2#",
"2 7#|2 #.-$-.#|3#-$.$-3#|#@-$.$.$-.#|3#-$.$-3#|2 #.-$-.#|2 7#",
"9#|#-#3.#-#|#-*-.-*-#|#-*-*-*-#|#-*-$-*-#|#-#3$#-#|#3 @3 #|9#",
"5 5#|5 #3 #|2 4#-$-4#|2 #2 #3 #2 #|2 #-2#-4#-#|5#.*.*.5#|#3 #*$-$*4 #|#-$-#.-@-.#-$-#|#4 *$-$*#3 #|5#.*.*.5#|2 #-4#-2#-#|2 #2 #3 #2 #|2 4#-$-4#|5 #3 #|5 5#",
"5#|#2 .2#|#2 #.2#|2#$-*.2#|#2 $-*.2#|#-*-$-#.#|#-$*-$2 #|#@3 #2 #|9#",
"-10#|2#2 #2 *2 5#|#3 #-*-*-#3 #|#-@2 *-$-*2 .-#|#3 #-*-*-#3 #|2#2 #2 *2 5#|-10#",
"-10#|2#2 #2 *2 5#|#3 #-*-*-#3 #|#-+2 *-$-*4 #|#3 #-*-*-#3 #|2#2 #2 *2 5#|-10#",
"-10#|2#2 #.-$-.#|#3 #-$.$-#|#-@2 $.$.$#|#3 #-$.$-#|2#2 #.-$-.#|-6#-3#|5 #3 #|5 #-.-#|5 #3 #|5 5#",
"4 5#|4 #3 #|4 #$.$#|4 #.-.#|5#$.$5#|#-$.$3 $.$-#|#-.-.-@-.-.-#|#-$.$3 $.$-#|5#$.$5#|4 #.-.#|4 #$.$#|4 #3 #|4 5#",
"9#|#5.2 #|#4 $#-#|#4.-#-#|#3 2$#-#|#3.2 #-#|#2 3$#-#|#2.3 #@#|#-4$3#|#.5 #|#5$-#|#6 #|8#",
#endif

};

// clang-format on

static int firstX = 999;
static int firstY = 999;
static int lastX = 0;
static int lastY = 0;

int unpackLength;

void putObject(bool dryRun, int *x, int y, unsigned char ch, int length) {

	if (!length)
		length = 1;

	unsigned char *board = ADDRESS_OF(y) + *x;
	for (int i = 0; i < length; i++) {
		if (!dryRun)
			*board++ = ch;

		if (ch == CH_PILL_1)
			pillCount++;

		if (dryRun && ch == CH_BRICKWALL) {
			if (*x + i < firstX)
				firstX = *x + i;
			if (*x + i > lastX)
				lastX = *x + i;
		}
	}

	if (dryRun && ch == CH_BRICKWALL) {
		if (y < firstY)
			firstY = y;
		if (y > lastY)
			lastY = y;
	}

	*x += length;
	unpackLength = 0;
}

int getRoomCount() { return sizeof(room) / sizeof(room[0]); }

int getRandomRoomNumber() { return rangeRandom(getRoomCount()); }

void setScroll() {

	int playerShoePixelX = manX * PIXELS_PER_CHAR + (PIXELS_PER_CHAR / 2) - 160 / 10;
	scrollX[DISPLAY_NORMAL] = playerShoePixelX << SHIFT_SCROLLX;
	clamp(&scrollX[DISPLAY_NORMAL], SCROLL_MAXIMUM_X_NORMAL);

	int playerShoePixelY = (manY + 1) * CHAR_HEIGHT / 3 - _ICC_SCANLINES / 2;
	scrollY[DISPLAY_NORMAL] = playerShoePixelY << SHIFT_SCROLLY;
	clamp(&scrollY[DISPLAY_NORMAL], SCROLL_MAXIMUM_Y_NORMAL);

	playerShoePixelX = manX * 3;
	scrollX[DISPLAY_HALF] = playerShoePixelX << SHIFT_SCROLLX;
	clamp(&scrollX[DISPLAY_HALF], SCROLL_MAXIMUM_X_HALF);

	playerShoePixelY =
	    (manY + 1) * CHAR_HEIGHT_HALF / 3 - (_ICC_SCANLINES - SCORE_SCANLINES / 3) / 2;
	scrollY[DISPLAY_HALF] = playerShoePixelY << SHIFT_SCROLLY;
	clamp(&scrollY[DISPLAY_HALF], SCROLL_MAXIMUM_Y_HALF);
}

void unpackRoom(BOUNDARY *boundary, bool dryRun, int roomNumber) {

	pillCount = 0;

	firstX = 999;
	firstY = 999;
	lastX = 0;
	lastY = 0;

	int x = boundary->x, y = boundary->y;

	unpackLength = 0;

	const char *p = room[roomNumber];
	while (*p) {

		switch (*p) {
		case NEXTLINE:
			y += unpackLength ? unpackLength : 1;
			x = boundary->x;
			break;

		case WALL:
			putObject(dryRun, &x, y, CH_BRICKWALL, unpackLength);
			break;

		case PLAYERONNORMAL:
			manX = x;
			manY = y;

			setScroll();

			putObject(dryRun, &x, y, CH_BLANK, unpackLength);
			break;

		case BOXONTARGET:
			putObject(dryRun, &x, y, CH_BOX_LOCKED, unpackLength);
			break;

		case PLAYERONGOAL:
			manX = x;
			manY = y;

			setScroll();

			[[fallthrough]];

		case TARGET:
			putObject(dryRun, &x, y, CH_PILL_1, unpackLength);
			break;

		case GAP:
		case GAP2:
		case GAP3:
			putObject(dryRun, &x, y, CH_BLANK, unpackLength);
			break;

		case BOX:
			putObject(dryRun, &x, y, CH_BOX, unpackLength);
			break;

		case '0':
		case '1':
		case '2':
		case '3':
		case '4':
		case '5':
		case '6':
		case '7':
		case '8':
		case '9':
			unpackLength = 10 * unpackLength + (*p - '0');
			break;

		default:
			break;
		}

		p++;
	}

	if (dryRun) {
		int width = lastX - firstX + 1;
		boundary->width = width < 0 ? 0 : width;

		int height = lastY - firstY + 1;
		boundary->height = height < 0 ? 0 : height;
	}

	else {
		unsigned char *board;
		for (int y = 0; y < __BOARD_DEPTH; y++) {

			for (int x = 0; x < __BOARD_WIDTH; x++) {
				board = ADDRESS_OF(y) + x;
				if (*board == CH_BLANK)
					*board = CH_STEELWALL;
				else
					break;
			}

			for (int x = __BOARD_WIDTH - 1; x >= 0; x--) {
				board = ADDRESS_OF(y) + x;
				if (*board == CH_BLANK)
					*board = CH_STEELWALL;
				else
					break;
			}
		}

		for (int x = 0; x < __BOARD_WIDTH; x++) {

			for (int y = 0; y < __BOARD_DEPTH; y++) {
				board = ADDRESS_OF(y) + x;
				if (*board != CH_BRICKWALL) //== CH_BLANK || *board == CH_STEELWALL)
					*board = CH_STEELWALL;
				else
					break;
			}

			for (int y = __BOARD_DEPTH - 1; y >= 0; y--) {
				board = ADDRESS_OF(y) + x;
				if (*board != CH_BRICKWALL) //== CH_BLANK || *board == CH_STEELWALL)
					*board = CH_STEELWALL;
				else
					break;
			}
		}
	}

	//	actualScore = pillCount;
}

// EOF
